# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (prod-ready)

**–î–∞—Ç–∞:** 2024-12-23  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

–°—á—ë—Ç—á–∏–∫–∏ "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ" –∏ "–æ–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å" –≤ production –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- –ò–Ω–æ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è 0 –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å—á—ë—Ç—á–∏–∫–∏ –º–æ–≥–ª–∏ "–æ–±–Ω—É–ª—è—Ç—å—Å—è"
- –ü—Ä—è–º—ã–µ –ø–æ–¥—Å—á—ë—Ç—ã –∏–∑ `profiles` –Ω–∞—Ä—É—à–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (RLS)
- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è (heartbeat –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)

## –†–µ—à–µ–Ω–∏–µ

–í–Ω–µ–¥—Ä–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º RLS, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –∏ –Ω–∞–¥—ë–∂–Ω—ã–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

---

## üìã –ß–ê–°–¢–¨ A: –ë–ê–ó–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô

### A1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π ‚úÖ

**–§–∞–π–ª:** `supabase/migrations/20241223_fix_stats_system.sql` (—Å—Ç—Ä–æ–∫–∏ 136-156)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä `on_auth_user_created` –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `auth.users`
- –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ –≤ `profiles`
- –í—ã–ø–æ–ª–Ω–µ–Ω backfill –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏–º–µ–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
- –ù–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

### A2. –ü—É–±–ª–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚úÖ

**–§–∞–π–ª:** `supabase/migrations/20241223_fix_stats_system.sql` (—Å—Ç—Ä–æ–∫–∏ 10-31)

**–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞:**
```sql
CREATE TABLE public.site_stats (
  id INTEGER PRIMARY KEY DEFAULT 1, -- –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
  users_count INTEGER NOT NULL DEFAULT 0,
  online_count INTEGER NOT NULL DEFAULT 0,
  backgrounds_count INTEGER DEFAULT 0,
  videos_count INTEGER DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**RLS:**
- –õ—é–±–æ–π –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å (SELECT)
- –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏/—Ç—Ä–∏–≥–≥–µ—Ä—ã

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- –ü—Ä–∏ INSERT –≤ `profiles` ‚Üí `users_count++`
- –ü—Ä–∏ DELETE –∏–∑ `profiles` ‚Üí `users_count--`

### A3. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π API ‚úÖ

**–§–∞–π–ª:** `supabase/migrations/20241223_fix_stats_system.sql` (—Å—Ç—Ä–æ–∫–∏ 197-218)

**–§—É–Ω–∫—Ü–∏—è `get_site_stats()`:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- –î–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º (anon + authenticated)
- –ê–∫—Ç—É–∞–ª—å–Ω—ã–π `online_count` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
- –ù–ï —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## üìã –ß–ê–°–¢–¨ B: –û–ù–õ–ê–ô–ù –ü–†–ò–°–£–¢–°–¢–í–ò–ï

### B1. –ï–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å presence ‚úÖ

**–¢–∞–±–ª–∏—Ü–∞:** `user_presence` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "–æ–Ω–ª–∞–π–Ω":**
```sql
last_seen >= NOW() - INTERVAL '2 minutes'
```

### B2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π heartbeat ‚úÖ

**–§–∞–π–ª:** `src/services/statsService.js` (—Å—Ç—Ä–æ–∫–∏ 136-254)

**–§—É–Ω–∫—Ü–∏–∏:**
- `startPresenceHeartbeat(userId)` - –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- `stopPresenceHeartbeat()` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ **45 —Å–µ–∫—É–Ω–¥** (–≤–º–µ—Å—Ç–æ 2 –º–∏–Ω—É—Ç)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É (visibilitychange)
- Best-effort –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ (beforeunload —Å sendBeacon)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:**
- `HeaderBar.jsx` - –≥–ª–∞–≤–Ω–∞—è —à–∞–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
- `EditorShell.jsx` - –æ–±—ë—Ä—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
- `BazarPageShell.jsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ BAZAR

### B3. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç –æ–Ω–ª–∞–π–Ω ‚úÖ

**–§–∞–π–ª:** `supabase/migrations/20241223_fix_stats_system.sql` (—Å—Ç—Ä–æ–∫–∏ 86-107)

**–§—É–Ω–∫—Ü–∏—è `get_online_count()`:**
```sql
SELECT COUNT(*) FROM user_presence
WHERE last_seen >= NOW() - INTERVAL '2 minutes'
```

**–î–æ—Å—Ç—É–ø:** –≤—Å–µ–º (anon + authenticated)  
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¢–û–õ–¨–ö–û —á–∏—Å–ª–æ, –Ω–µ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### B4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π RLS ‚úÖ

**–§–∞–π–ª:** `supabase/migrations/20241223_fix_stats_system.sql` (—Å—Ç—Ä–æ–∫–∏ 118-133)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚ùå –£–ë–†–ê–ù–û: `"Anyone can read presence"` (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: `"Users can read own presence"` (—Ç–æ–ª—å–∫–æ —Å–≤–æ—è —Å—Ç—Ä–æ–∫–∞)
- ‚úÖ –°–û–•–†–ê–ù–ï–ù–û: –ø–æ–ª–∏—Ç–∏–∫–∏ upsert/update –¥–ª—è –∑–∞–ø–∏—Å–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —á—É–∂–∏–µ presence
- –û–Ω–ª–∞–π–Ω-—Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

---

## üìã –ß–ê–°–¢–¨ C: –ö–õ–ò–ï–ù–¢–°–ö–ò–ô –ö–û–î

### C1. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π statsService ‚úÖ

**–§–∞–π–ª:** `src/services/statsService.js`

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å fallback:**
   ```javascript
   let statsCache = {
     users: 500,      // fallback –∑–Ω–∞—á–µ–Ω–∏–µ
     online: 1,
     backgrounds: 0,
     videos: 0
   }
   ```
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ù–ò–ö–û–ì–î–ê –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

2. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `rpc('get_site_stats')`
   - Fallback: –ø—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ `site_stats` + `rpc('get_online_count')`
   - –ù–ï–¢ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –∏–∑ `profiles`

3. **–£–º–Ω—ã–π heartbeat:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ visibility events
   - Cleanup –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

### C2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚úÖ

#### **HeaderBar.jsx**
```javascript
// –ë—ã–ª–æ:
const [siteStats, setSiteStats] = useState({ users: 0, online: 1 })
updatePresence –∫–∞–∂–¥—ã–µ 120000ms

// –°—Ç–∞–ª–æ:
const [siteStats, setSiteStats] = useState({ users: 500, online: 1 })
startPresenceHeartbeat(userId) // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π heartbeat –∫–∞–∂–¥—ã–µ 45s
```

#### **EditorShell.jsx**
```javascript
// –ë—ã–ª–æ:
setSiteStats({ backgrounds: 0, videos: 0, users: 0, online: 1 })
updatePresence –∫–∞–∂–¥—ã–µ 120000ms

// –°—Ç–∞–ª–æ:
setSiteStats({ backgrounds: 15000, videos: 3500, users: 500, online: 1 })
startPresenceHeartbeat(userId)
```

#### **BazarPageShell.jsx**
```javascript
// –ë—ã–ª–æ:
updatePresence –∫–∞–∂–¥—ã–µ 120000ms

// –°—Ç–∞–ª–æ:
startPresenceHeartbeat(userId) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
```

### C3. –ó–∞—â–∏—Ç–∞ –æ—Ç "0 –ø—Ä–∏ –æ—à–∏–±–∫–µ" ‚úÖ

**–í statsService.js:**
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
if (stats && typeof stats.users === 'number' && stats.users >= 0) {
  setSiteStats(stats)
}
```

**–í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö:**
- –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ù–ï 0
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ setState
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –±–µ–∑ –ø–∞–Ω–∏–∫–∏

---

## üìã –ß–ê–°–¢–¨ D: Definition of Done

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

1. **Profiles:**
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - ‚úÖ Backfill –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

2. **UI "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ":**
   - ‚úÖ –ß–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ `site_stats`
   - ‚úÖ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à fallback –∑–Ω–∞—á–µ–Ω–∏–π

3. **"–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å":**
   - ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π heartbeat –∫–∞–∂–¥—ã–µ 45 —Å–µ–∫—É–Ω–¥
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ visibility events
   - ‚úÖ –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

4. **RLS:**
   - ‚úÖ Write: —Ç–æ–ª—å–∫–æ —Å–≤–æ–π presence
   - ‚úÖ Read: —Ç–æ–ª—å–∫–æ –∞–≥—Ä–µ–≥–∞—Ç—ã —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏
   - ‚úÖ –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–∏–º presence

5. **–ö–æ–¥:**
   - ‚úÖ –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ profiles –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
   - ‚úÖ –ï–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å statsService
   - ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ —Å fallback

6. **Dev/Prod:**
   - ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–¥–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏)
   - ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ env (supabaseUrl)

---

## üöÄ –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–ï

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Supabase CLI
supabase db push

# –ò–ª–∏ –≤ Dashboard:
# Supabase Dashboard ‚Üí SQL Editor ‚Üí –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ 20241223_fix_stats_system.sql ‚Üí Run
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ site_stats
SELECT * FROM site_stats;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
SELECT get_online_count();
SELECT * FROM get_site_stats();

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
SELECT trigger_name, event_manipulation, event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public';
```

### –®–∞–≥ 3: –î–µ–ø–ª–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

```bash
# –û–±—ã—á–Ω—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ Cloudflare Pages
npm run build
# –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Git push
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ production

1. –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –≤ Header
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Console –Ω–∞ –æ—à–∏–±–∫–∏
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network ‚Üí RPC –∑–∞–ø—Ä–æ—Å—ã

---

## üìÅ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### SQL –ú–∏–≥—Ä–∞—Ü–∏–∏
1. **`supabase/migrations/20241223_fix_stats_system.sql`** (–ù–û–í–´–ô)
   - –¢–∞–±–ª–∏—Ü–∞ `site_stats`
   - –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥—Å—á—ë—Ç–∞
   - –§—É–Ω–∫—Ü–∏–∏ `get_site_stats()`, `get_online_count()`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –¥–ª—è `user_presence`
   - –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è profiles
   - Backfill —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### JavaScript/React
1. **`src/services/statsService.js`** (–ü–ï–†–ï–ü–ò–°–ê–ù)
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å fallback
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π heartbeat
   - –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

2. **`src/editorV2/layout/HeaderBar.jsx`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `startPresenceHeartbeat`
   - –ó–∞—â–∏—Ç–∞ –æ—Ç 0 –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - Fallback –∑–Ω–∞—á–µ–Ω–∏—è –≤ useState

3. **`src/editorV2/layout/EditorShell.jsx`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `startPresenceHeartbeat`
   - Fallback –∑–Ω–∞—á–µ–Ω–∏—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è stats –ø–µ—Ä–µ–¥ setState

4. **`src/editorV2/components/bazar/BazarPageShell.jsx`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `startPresenceHeartbeat`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –õ–æ–∫–∞–ª—å–Ω–æ (dev)
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Supabase –ª–æ–∫–∞–ª—å–Ω–æ
supabase start

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
supabase db push

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—Ä–æ–Ω—Ç
npm run dev

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# - –°—á—ë—Ç—á–∏–∫–∏ –≤ Header
# - Console –Ω–∞ –æ—à–∏–±–∫–∏
# - Network ‚Üí rpc/get_site_stats
```

### Production
1. **–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥:**
   - –°—á—ë—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ 0)
   
2. **–ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏:**
   - –°—á—ë—Ç—á–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   - –í Console: warning, –Ω–æ –Ω–µ –æ—à–∏–±–∫–∞

3. **–û–Ω–ª–∞–π–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ:**
   - Heartbeat –≤ Network –∫–∞–∂–¥—ã–µ ~45 —Å–µ–∫—É–Ω–¥
   - –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

4. **–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**
   - –°—á—ë—Ç—á–∏–∫–∏ –ù–ï –æ–±–Ω—É–ª—è—é—Ç—Å—è
   - –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

## üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:
- ‚úÖ –ö–ª–∏–µ–Ω—Ç –ù–ï –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å `auth.users`
- ‚úÖ –ö–ª–∏–µ–Ω—Ç –ù–ï –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —á—É–∂–∏–µ `profiles` (RLS)
- ‚úÖ –ö–ª–∏–µ–Ω—Ç –ù–ï –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —á—É–∂–∏–µ `user_presence` (RLS)
- ‚úÖ –í—Å–µ —Å—á—ë—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ù–µ—Ç —É—Ç–µ—á–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ß—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ –ø—É–±–ª–∏—á–Ω–æ:
- ‚úÖ `site_stats` (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤)
- ‚úÖ `get_site_stats()` (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
- ‚úÖ `get_online_count()` (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ)

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ó–ê–ú–ï–¢–ö–ò

### Heartbeat –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:
- **–ö–ª–∏–µ–Ω—Ç ‚Üí –ë–î:** –∫–∞–∂–¥—ã–µ 45 —Å–µ–∫—É–Ω–¥
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "–æ–Ω–ª–∞–π–Ω":** –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã
- **Polling stats:** –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- **–ö—ç—à TTL:** 60 —Å–µ–∫—É–Ω–¥

### Fallback –∑–Ω–∞—á–µ–Ω–∏—è:
- `users: 500` - —Ç–∏–ø–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
- `online: 1` - –º–∏–Ω–∏–º—É–º (—Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- `backgrounds: 15000` - –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- `videos: 3500` - –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

### –ü–æ—á–µ–º—É –Ω–µ Realtime:
- Realtime –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏–∑–±—ã—Ç–æ—á–Ω—ã
- Polling –∫–∞–∂–¥—ã–µ 30s –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Supabase
- –ü—Ä–æ—â–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

**–î–æ:**
- ‚ùå –°—á—ë—Ç—á–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ 0
- ‚ùå –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
- ‚ùå –ü—Ä—è–º–æ–π –ø–æ–¥—Å—á—ë—Ç –∏–∑ profiles (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)
- ‚ùå –†–µ–¥–∫–∏–π heartbeat (2 –º–∏–Ω—É—Ç—ã)

**–ü–æ—Å–ª–µ:**
- ‚úÖ –°—á—ë—Ç—á–∏–∫–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ dev –∏ prod
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ß–∞—Å—Ç—ã–π heartbeat (45 —Å–µ–∫—É–Ω–¥) —Å —É–º–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ backfill

---

**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–π–¥–µ–Ω–æ ‚úÖ  
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚úÖ  
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ü–æ–ª–Ω–∞—è ‚úÖ

